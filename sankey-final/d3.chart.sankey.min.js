// This script is retrieved from d3 lib
// mainly for interactions in sankey
!function(a,b)
{
	"use strict";
	"function"==typeof a.define&&a.define.amd?define(["d3"],
		function(c){b(a,c)}):b(a,a.d3)
}
(this,function(a,b){
	"use strict";
	function c(a,b){
		return a.source&&a.target?d(a,b):e(a,b)
	}
	function d(a,b){
		var c=[a];return b=b||"both",("source"==b||"both"==b)&&(c=c.concat(e(a.source,"source"))),
		("target"==b||"both"==b)&&(c=c.concat(e(a.target,"target"))),c
	}
	function e(a,b){
		var c=[a];return b=b||"both",
		("source"==b&&a.sourceLinks.length<2||"both"==b)&&a.targetLinks.forEach(function(a){c=c.concat(d(a,b))}),
		("target"==b&&a.targetLinks.length<2||"both"==b)&&a.sourceLinks.forEach(function(a){c=c.concat(d(a,b))}),c
	}
	b.chart("Sankey.Base",{
		initialize:function(){
			var a=this;
			a.features={},
			a.d3={},
			a.layers={},
			a.base.attr("width",a.base.node().parentNode.clientWidth),
			a.base.attr("height",a.base.node().parentNode.clientHeight),
			a.features.margins={top:20,right:20,bottom:20,left:20},
			a.features.width=a.base.attr("width")-a.features.margins.left-a.features.margins.right,
			a.features.height=a.base.attr("height")-a.features.margins.top-a.features.margins.bottom,
			a.features.name=function(a){return a.name},
			a.features.colorNodes=b.scale.category20c(),
			a.features.colorLinks=null,
			a.layers.base=a.base.append("g")
				.attr("transform","translate("+a.features.margins.left+","+a.features.margins.top+")")
		},
		name:function(a){
			return arguments.length?(this.features.name=a,this.trigger("change:name"),
				this.root&&this.draw(this.root),this):this.features.name
		},
		colorNodes:function(a){
			return arguments.length?(this.features.colorNodes=a,
				this.trigger("change:color"),
				this.root&&this.draw(this.root),this):this.features.colorNodes
		},
		colorLinks:function(a){
			return arguments.length?(this.features.colorLinks=a,this.trigger("change:color"),
				this.data&&this.draw(this.data),this):this.features.colorLinks
		}
	}),
	b.chart("Sankey.Base")
	.extend("Sankey",{initialize:function(){
		function a(a){
			return a.x<e.features.width/2
		}
		function c(a){
			return"function"==typeof e.features.colorNodes?e.features.colorNodes(e.features.name(a),a):e.features.colorNodes
		}
		function d(a){
			return"function"==typeof e.features.colorLinks?e.features.colorLinks(a):e.features.colorLinks
		}
		var e=this;
		e.d3.sankey=b.sankey(),
		e.d3.path=e.d3.sankey.link(),
		e.d3.sankey.size([e.features.width,e.features.height]),
		e.features.spread=!1,e.features.iterations=32,
		e.features.nodeWidth=e.d3.sankey.nodeWidth(),
		e.features.nodePadding=e.d3.sankey.nodePadding(),
		e.layers.links=e.layers.base.append("g").classed("links",!0),
		e.layers.nodes=e.layers.base.append("g").classed("nodes",!0),
		e.on("change:sizes",function(){
			e.d3.sankey.nodeWidth(e.features.nodeWidth),
			e.d3.sankey.nodePadding(e.features.nodePadding)
		}),
		e.layer("links",e.layers.links,{
			dataBind:function(a){
				return this.selectAll(".link").data(a.links)
			},
			insert:function(){
				return this.append("path").classed("link",!0)
			},
			events:{
				enter:function(){
					this.on("mouseover",function(a){
						e.trigger("link:mouseover",a)
					}),
					this.on("mouseout",function(a){
						e.trigger("link:mouseout",a)
					}),
					this.on("click",function(a){
						e.trigger("link:click",a)
					})
				},
				merge:function(){
					this.append("title")
					.text(function(d){ return d.source.name.split("_")[0] +" Session "+d.source.name.split("_")[1]+"-->"+d.target.name.split("_")[0] +" Session "+d.target.name.split("_")[1]+": "+d.value; }),
					this.attr("d",e.d3.path)
					.style("stroke",d)
					.style("stroke-width",function(a){
						return Math.max(1,a.dy)
					})
					.sort(function(a,b){
						return b.dy-a.dy
					})
				},
				exit:function(){
					this.remove()
				}
			}
		}),
		e.layer("nodes",e.layers.nodes,{
			dataBind:function(a){
				return this.selectAll(".node").data(a.nodes)},
				insert:function(){
					return this.append("g").classed("node",!0)},
					events:{
						enter:function(){
							this.append("rect"),
							this.append("title")
							.attr("dy",".35em")
							.attr("transform",null),
							this.on("mouseover",function(a){
								e.trigger("node:mouseover",a)
							}),
							this.on("mouseout",function(a){
								e.trigger("node:mouseout",a)
							}),
							this.on("click",function(a){
								e.trigger("node:click",a)
							})
						},
						merge:function(){
							this.attr("transform",function(a){
								return"translate("+a.x+","+a.y+")"
							}),
							this.select("rect")
							.attr("height",function(a){
								return a.dy
							})
							.attr("width",e.features.nodeWidth)
							.style("fill",c)
							.style("stroke",function(a){
								return b.rgb(c(a)).darker(2)
							}),
							this.select("title")
							.text(function(a){ return a.name.split("_")[0] +" Session "+a.name.split("_")[1]+": "+ a.value})
							.attr("y",function(a){return a.dy/2})
							.attr("x",function(b){return a(b)?6+e.features.nodeWidth:-6})
							.attr("text-anchor",function(b){return a(b)?"start":"end"})
						},
						exit:function(){this.remove()}
					}
				})
			},
			transform:function(a){
				var b=this;
				return b.data=a,b.d3.sankey.nodes(a.nodes).links(a.links).layout(b.features.iterations),this.features.spread&&(this._spreadNodes(a),b.d3.sankey.relayout()),a
			},
			iterations:function(a){
				return arguments.length?(this.features.iterations=a,this.data&&this.draw(this.data),this):this.features.iterations
			},
			nodeWidth:function(a){
				return arguments.length?(this.features.nodeWidth=a,this.trigger("change:sizes"),this.data&&this.draw(this.data),this):this.features.nodeWidth
			},
			nodePadding:function(a){
				return arguments.length?(this.features.nodePadding=a,this.trigger("change:sizes"),this.data&&this.draw(this.data),this):this.features.nodePadding
			},
			spread:function(a){
				return arguments.length?(this.features.spread=a,this.data&&this.draw(this.data),this):this.features.spread
			},
			_spreadNodes:function(a){
				var c=this,
					d=b.nest().key(function(a){return a.x})
					.entries(a.nodes).map(function(a){
						return a.values
					});
				d.forEach(function(a){
					var d,e,f=b.sum(a,function(a){return a.dy}),
					g=(c.features.height-f)/a.length,h=0;
					for(a.sort(function(a,b){
						return a.y-b.y}),d=0;d<a.length;++d)e=a[d],e.y=h,h+=e.dy+g
				})
			}
		}),
	b.chart("Sankey")
	.extend("Sankey.Selection",{
		initialize:function(){
			function a(){
				return c.features.selection&&c.features.selection.length?this.style("opacity",function(a){
					return c.features.selection.indexOf(a)>=0?1:c.features.unselectedOpacity}):this.style("opacity",0.9)
			}
			function b(){
				var b=c.layers.base.selectAll(".node, .link").transition();
				c.features.selection&&c.features.selection.length||(b=b.delay(100)),a.apply(b.duration(50))
			}
			var c=this;
			c.features.selection=null,
			c.features.unselectedOpacity=.3,
			c.on("link:mouseover",c.selection),
			c.on("link:mouseout",function(){c.selection(null)}),
			c.on("node:mouseover",c.selection),
			c.on("node:mouseout",function(){c.selection(null)}),
			c.on("change:selection",b),
			this.layer("links").on("enter",a),
			this.layer("nodes").on("enter",a)},
			selection:function(a){
				return arguments.length?(this.features.selection=!a||a instanceof Array?a:[a],this.trigger("change:selection"),this):this.features.selection
			},
			unselectedOpacity:function(a){
				return arguments.length?(this.features.unselectedOpacity=a,this.trigger("change:selection"),this):this.features.unselectedOpacity
			}
		}),
		b.chart("Sankey.Selection")
		.extend("Sankey.Path",{
			selection:function(a){
				var b=this;
				return arguments.length?(b.features.selection=!a||a instanceof Array?a:[a],b.features.selection&&b.features.selection.forEach(function(a){
					c(a).forEach(function(a){
						b.features.selection.push(a)
					})
				}),
				b.trigger("change:selection"),b):b.features.selection
			}
		})
	});